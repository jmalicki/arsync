name: CI (Optimized)

on:
  push:
    branches:
      - main
  pull_request:
    # No branches specified = all PRs
  schedule:
    - cron: '0 0 * * 1'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # RUSTC_WRAPPER: sccache  # Temporarily disabled
  # SCCACHE_GHA: true

permissions:
  contents: read
  checks: write
  actions: read

jobs:
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: ./.github/actions/setup-rust-optimized
    
    - name: Check formatting
      run: cargo fmt --all -- --check
    
    - name: Run clippy
      run: |
        cargo clippy --all-targets --features remote-sync,benchmarks -- \
          -D warnings \
          -D clippy::missing_docs_in_private_items \
          -D clippy::missing_errors_doc \
          -D clippy::missing_panics_doc \
          -D clippy::must_use_candidate \
          -D clippy::unwrap_used \
          -D clippy::expect_used \
          -D clippy::panic \
          -D clippy::todo \
          -D clippy::unimplemented \
          -D clippy::unreachable

  dependencies:
    name: Dependency Check
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: ./.github/actions/setup-rust-optimized
    
    - name: Install cargo-deny
      uses: taiki-e/install-action@v2
      with:
        tool: cargo-deny@0.17.0

    - name: Install cargo-outdated
      uses: taiki-e/install-action@v2
      with:
        tool: cargo-outdated@0.17
    
    - name: Check dependencies with cargo-deny
      run: cargo deny check
    
    - name: Check for outdated dependencies
      run: cargo outdated --depth 1 --color always --exit-code 1 --ignore cargo-deny
      continue-on-error: ${{ github.event_name == 'pull_request' }}

  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: code-quality
    strategy:
      fail-fast: false
      matrix:
        # Windows disabled - needs design rethinking for DirectoryFd architecture
        # macOS disabled temporarily - has some test failures, will fix in separate PR
        # Windows lacks Unix *at syscalls (symlinkat, fchmodat, etc.) which are core to DirectoryFd
        # Future work: Design Windows-specific approach or path-based helpers
        os: [ubuntu-latest]
        # os: [ubuntu-latest, macos-latest]  # TODO: Re-enable macOS in separate PR
        rust: 
          - stable
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: ./.github/actions/setup-rust-optimized
      with:
        toolchain: ${{ matrix.rust }}
    
    - name: Install cargo-nextest
      uses: taiki-e/install-action@v2
      with:
        tool: nextest
    
    # Linux: Build all tests
    - name: Build all tests (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: cargo test --no-run --features remote-sync,benchmarks
    
    # macOS: Only build compio-fs-extended tests
    - name: Build compio-fs-extended tests (macOS)
      if: matrix.os == 'macos-latest'
      run: cargo test --no-run --features remote-sync,benchmarks --package compio-fs-extended
    
    # Linux: Run full test suite (parent project + compio-fs-extended)
    - name: Run fast tests (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        cargo nextest run --profile ci --features remote-sync,benchmarks \
          -E '!binary(~integration) & !binary(~performance) & !binary(~rsync)'
    
    # macOS: Only test compio-fs-extended (parent project has Linux-specific code for now)
    - name: Run compio-fs-extended tests (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        cargo nextest run --profile ci --features remote-sync,benchmarks --package compio-fs-extended
    
    # macOS: Only test compio-fs-extended docs
    - name: Run doc tests
      if: matrix.os == 'macos-latest'
      run: cargo test --features remote-sync,benchmarks --doc --package compio-fs-extended
    
    # Linux: Test all docs
    - name: Run doc tests (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: cargo test --features remote-sync,benchmarks --doc
    
    - name: Build release binary (Linux only for now)
      if: matrix.os == 'ubuntu-latest'
      run: cargo build --release

  integration-tests:
    name: Integration Tests (${{ matrix.rust }})
    runs-on: ubuntu-latest
    needs: test
    strategy:
      fail-fast: false
      matrix:
        rust: 
          - stable
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: ./.github/actions/setup-rust-optimized
      with:
        toolchain: ${{ matrix.rust }}
    
    - name: Install cargo-nextest
      uses: taiki-e/install-action@v2
      with:
        tool: nextest
    
    - name: Build all tests
      run: cargo test --no-run --features remote-sync,benchmarks
    
    - name: Run integration tests
      run: cargo nextest run --profile ci --features remote-sync,benchmarks -E 'binary(~integration)'
    
    - name: Run metadata tests
      run: cargo nextest run --profile ci --features remote-sync,benchmarks -E 'binary(~metadata)'
    
    - name: Run xattr tests
      run: cargo nextest run --profile ci --features remote-sync,benchmarks -E 'binary(~xattr)'
    
    - name: Run rsync tests
      run: cargo nextest run --profile ci --features remote-sync,benchmarks -E 'binary(~rsync)'

  docker-tests:
    name: Docker Tests (privileged)
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: ./.github/actions/setup-rust-optimized
    
    - name: Install cargo-nextest
      uses: taiki-e/install-action@v2
      with:
        tool: nextest
    
    - name: Build release binary for container tests
      run: cargo build --release --bin arsync
    
    - name: Build all tests
      run: cargo test --no-run --features remote-sync,benchmarks
    
    - name: Run Docker-based tests
      run: cargo nextest run --profile ci --features remote-sync,benchmarks -E 'test(/docker/)'
      env:
        # Docker is available in GitHub Actions by default
        DOCKER_AVAILABLE: true

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: ./.github/actions/setup-rust-optimized
    
    - name: Install cargo-nextest
      uses: taiki-e/install-action@v2
      with:
        tool: nextest
    
    - name: Build all tests
      run: cargo test --no-run --features remote-sync,benchmarks
    
    - name: Run performance tests
      run: cargo nextest run --profile ci --features remote-sync,benchmarks -E 'binary(~performance)'

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: [code-quality, test, integration-tests]
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: ./.github/actions/setup-rust-optimized
  
    - name: Install tarpaulin
      uses: taiki-e/install-action@v2
      with:
        tool: cargo-tarpaulin@0.32.8
          
    - name: Generate coverage report
      run: cargo tarpaulin --lib --features remote-sync,benchmarks --out Html --output-dir coverage
    
    - name: Upload coverage artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/
        retention-days: 30

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: ./.github/actions/setup-rust-optimized
    
    - name: Install cargo-audit
      uses: taiki-e/install-action@v2
      with:
        tool: cargo-audit@0.21
    
    - name: Run security audit
      run: cargo audit --deny warnings
      continue-on-error: ${{ github.event.schedule != '' }}

  benchmark:
    name: Benchmark
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'
    needs: code-quality
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Rust
      uses: ./.github/actions/setup-rust-optimized
    
    - name: Run benchmarks
      run: cargo bench --features remote-sync,benchmarks
    
    - name: Upload benchmark artifacts
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: target/criterion/
        retention-days: 30

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    needs: [code-quality, test, integration-tests, docker-tests]
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: ./.github/actions/setup-rust-optimized
    
    - name: Build documentation
      run: cargo doc --document-private-items --no-deps --features remote-sync,benchmarks
      env:
        RUSTDOCFLAGS: -D warnings
    
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./target/doc
        force_orphan: true

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: 
      - code-quality
      - dependencies
      - test
      - integration-tests
      - docker-tests
      - coverage
      - security
      - docs
    if: always()
    steps:
      - name: Check all jobs success
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          if [[ "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "One or more jobs were cancelled"
            exit 1
          fi
          echo "All jobs succeeded!"
          echo "Note: Performance tests run conditionally on main branch"
